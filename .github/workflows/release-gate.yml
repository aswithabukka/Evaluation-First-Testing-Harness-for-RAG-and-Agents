name: Release Gate Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  gate-status:
    name: Check Release Gate
    runs-on: ubuntu-latest

    steps:
      - name: Check evaluation status via API
        id: gate_check
        env:
          RAGEVAL_API_URL: ${{ secrets.RAGEVAL_API_URL }}
        run: |
          if [ -z "$RAGEVAL_API_URL" ]; then
            echo "RAGEVAL_API_URL secret not set — skipping gate check"
            echo "gate_passed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Query the latest completed evaluation run for this commit
          COMMIT_SHA="${{ github.event.pull_request.head.sha }}"
          RESPONSE=$(curl -sf \
            "${RAGEVAL_API_URL}/api/v1/runs?git_commit_sha=${COMMIT_SHA}&limit=1" \
            -H "Accept: application/json" \
            || echo "[]")

          OVERALL_PASSED=$(echo "$RESPONSE" | python3 -c "
          import json, sys
          runs = json.load(sys.stdin)
          if runs:
              print(str(runs[0].get('overall_passed', None)).lower())
          else:
              print('none')
          ")

          echo "overall_passed=${OVERALL_PASSED}" >> "$GITHUB_OUTPUT"

          if [ "$OVERALL_PASSED" = "true" ]; then
            echo "✅ Release gate PASSED"
          elif [ "$OVERALL_PASSED" = "false" ]; then
            echo "❌ Release gate BLOCKED — evaluation failed"
            exit 1
          else:
            echo "⚠️ No evaluation found for commit ${COMMIT_SHA} — gate check skipped"
            echo "Run 'make eval-local' or trigger the 'RAG Evaluation' workflow first"
          fi

      - name: Set commit status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const passed = '${{ steps.gate_check.outputs.gate_passed }}';
            const state = passed === 'true' ? 'success' : 'failure';
            const description = passed === 'true'
              ? 'All evaluation metrics passed'
              : 'Evaluation gate blocked — quality regression detected';

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state,
              description,
              context: 'RAG Eval Harness / Release Gate',
            });
